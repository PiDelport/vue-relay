!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e["vue-relay"]=t()}(this,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},a=require("fbjs/lib/invariant"),i=function(){function e(){t(this,e),this._selectionReferences=[]}return n(e,[{key:"lookupInStore",value:function(e,t){return e.check(t.root)?(this._retainCachedOperation(e,t),e.lookup(t.fragment)):null}},{key:"execute",value:function(e){var t=this,n=e.environment,r=e.operation,a=e.cacheConfig,i=e.preservePreviousReferences,o=void 0!==i&&i,s=n.unstable_internal.createOperationSelector,c=[];return n.execute({operation:r,cacheConfig:a}).map(function(e){var t=s(r.node,e.variables,e.operation);return c.push(n.retain(t.root)),e}).do({error:function(){t._selectionReferences=t._selectionReferences.concat(c)},complete:function(){o||t._disposeSelectionReferences(),t._selectionReferences=t._selectionReferences.concat(c)},unsubscribe:function(){t._selectionReferences=t._selectionReferences.concat(c)}})}},{key:"fetch",value:function(e){var t=this,n=e.cacheConfig,r=e.environment,a=e.onDataChange,i=e.operation,o=!1,s=void 0;this._disposeRequest(),this._fetchOptions=e;var c=this.execute({environment:r,operation:i,cacheConfig:n}).finally(function(){t._pendingRequest=null}).subscribe({next:function(){t._onQueryDataAvailable({notifyFirstResult:o})},error:function(e){o?a({error:e}):s=e}});if(this._pendingRequest={dispose:function(){c.unsubscribe()}},o=!0,s)throw s;return this._snapshot}},{key:"retry",value:function(){return a(this._fetchOptions,"RelayQueryFetcher: `retry` should be called after having called `fetch`"),this.fetch(this._fetchOptions)}},{key:"dispose",value:function(){this._disposeRequest(),this._disposeSelectionReferences()}},{key:"_disposeRequest",value:function(){this._snapshot=null,this._pendingRequest&&this._pendingRequest.dispose(),this._rootSubscription&&(this._rootSubscription.dispose(),this._rootSubscription=null)}},{key:"_retainCachedOperation",value:function(e,t){this._disposeCacheSelectionReference(),this._cacheSelectionReference=e.retain(t.root)}},{key:"_disposeCacheSelectionReference",value:function(){this._cacheSelectionReference&&this._cacheSelectionReference.dispose(),this._cacheSelectionReference=null}},{key:"_disposeSelectionReferences",value:function(){this._disposeCacheSelectionReference(),this._selectionReferences.forEach(function(e){return e.dispose()}),this._selectionReferences=[]}},{key:"_onQueryDataAvailable",value:function(e){var t=e.notifyFirstResult;a(this._fetchOptions,"RelayQueryFetcher: `_onQueryDataAvailable` should have been called after having called `fetch`");var n=this._fetchOptions,r=n.environment,i=n.onDataChange,o=n.operation;this._snapshot||(this._snapshot=r.lookup(o.fragment),this._rootSubscription=r.subscribe(this._snapshot,function(e){return i({snapshot:e})}),this._snapshot&&t&&i({snapshot:this._snapshot}))}}]),e}(),o=require("fbjs/lib/areEqual"),s=function(e,t,n,r){return{error:e,props:t?t.data:null,retry:function(){var t=n.retry();t?r.handleDataChange({snapshot:t}):e&&r.handleRetryAfterError(e)}}},c=function(e,t,n){var r=e.environment,a=e.query,i=e.variables;if(!a)return t.dispose(),{relayContextEnvironment:r,relayContextVariables:i,renderProps:{error:null,props:{},retry:null}};var o=r,c=o.unstable_internal,l=(0,c.createOperationSelector)((0,c.getRequest)(a),i);try{var u="STORE_THEN_NETWORK"===e.dataFrom?t.lookupInStore(o,l):null,h=t.fetch({cacheConfig:e.cacheConfig,dataFrom:e.dataFrom,environment:o,onDataChange:n.handleDataChange,operation:l})||u;return h?{relayContextEnvironment:r,relayContextVariables:l.variables,renderProps:s(null,h,t,n)}:{relayContextEnvironment:r,relayContextVariables:l.variables,renderProps:{error:null,props:null,retry:null}}}catch(e){return{relayContextEnvironment:r,relayContextVariables:l.variables,renderProps:s(e,null,t,n)}}},l={name:"relay-query-renderer",props:{cacheConfig:{},dataFrom:{},environment:{required:!0},query:{},variables:{type:Object,default:function(){return{}}}},data:function(){var e=this,t={handleDataChange:function(r){var a=r.error,i=r.snapshot;e.setState({renderProps:s(a,i,n,t)})},handleRetryAfterError:function(t){e.setState({renderProps:{error:null,props:null,retry:null}})}},n=new i,a=c(this.$props,n,t);return{context:Object.freeze({relay:{environment:a.relayContextEnvironment,variables:a.relayContextVariables}}),state:Object.freeze(r({prevPropsEnvironment:this.environment,prevPropsVariables:this.variables,prevQuery:this.query,queryFetcher:n,retryCallbacks:t},a)),switch:!0}},computed:{props:function(){var e=this;return Object.keys(this.$props).forEach(function(t){return e[t]}),this.switch=!this.switch}},methods:{setState:function(e){this.state=Object.freeze(r({},this.state,e))}},watch:{props:function(){if(this.state.prevQuery!==this.query||this.state.prevPropsEnvironment!==this.environment||!o(this.state.prevPropsVariables,this.variables)){var e=c(this.$props,this.state.queryFetcher,this.state.retryCallbacks);this.context.relay.environment=e.relayContextEnvironment,this.context.relay.variables=e.relayContextVariables,this.setState(r({prevQuery:this.query,prevPropsEnvironment:this.environment,prevPropsVariables:this.variables},e))}}},render:function(e){return e(this.component)},created:function(){var e=this;this.component={name:"relay-context-provider",provide:{relay:this.context.relay},render:function(t){return t("keep-alive",{props:{include:[]}},e.$scopedSlots.default(e.state.renderProps))}}},beforeDestroy:function(){this.state.queryFetcher.dispose()}},u=function(t){return"object"===(void 0===t?"undefined":e(t))&&null!==t&&!Array.isArray(t)&&("object"===(void 0===(r=t.environment)?"undefined":e(r))&&null!==r&&"function"==typeof r.applyMutation&&"function"==typeof r.check&&"function"==typeof r.check&&"function"==typeof r.lookup&&"function"==typeof r.retain&&"function"==typeof r.sendMutation&&"function"==typeof r.sendQuery&&"function"==typeof r.execute&&"function"==typeof r.subscribe)&&("object"===(void 0===(n=t.variables)?"undefined":e(n))&&null!==n&&!Array.isArray(n));var n,r},h=require("fbjs/lib/invariant"),p=require("fbjs/lib/mapObject"),f=function(e,t,n){return{name:"relay-context-consumer",inject:["relay"],render:function(e){return e(this.component,{props:this.$attrs})},created:function(){var a=function(e){return h(u(e),"RelayContextConsumer: Expected `relayContext` to be an object conforming to the `RelayContext` interface, got `%s`.",e),e}(this.relay).environment.unstable_internal.getFragment,i=p(t,a),o=this;this.component={extends:n.call(this,i),props:Object.keys(i),render:function(e){return this.context?e(this.component):this.component.render(e)},created:function(){var t=this;this.component={name:"relay-context-provider",provide:{relay:(this.context||o).relay},render:function(n){return null!=e?n(e,{props:r({},t.$attrs,t.state.data,{relay:t.state.relayProp})}):n("keep-alive",{props:{include:[]}},o.$scopedSlots.default(r({},t.state.data,{relay:t.state.relayProp})))}}}}}}},v=require("fbjs/lib/areEqual"),b=require("fbjs/lib/invariant"),y=require("relay-runtime").Observable,d=require("fbjs/lib/areEqual"),m=require("fbjs/lib/invariant"),g=require("fbjs/lib/warning"),_=require("relay-runtime"),S=_.ConnectionInterface,R=_.Observable,C=function(e){var t=e.count;return m(t,"RelayPaginationContainer: Unable to synthesize a getFragmentVariables function."),function(e,n){return r({},e,(o=n,(i=t)in(a={})?Object.defineProperty(a,i,{value:o,enumerable:!0,configurable:!0,writable:!0}):a[i]=o,a));var a,i,o}},P=function(e){return"function"==typeof e?{error:e,complete:e,unsubscribe:function(t){"function"==typeof e&&e()}}:e||{}},F=function(t,n){var a=this.relay,o=function(e){var t=null,n=!1;for(var a in e){var i=e[a],o=i.metadata&&i.metadata.connection;void 0!==i.metadata&&(n=!0),o&&(m(1===o.length,"RelayPaginationContainer: Only a single @connection is supported, `%s` has %s.",a,o.length),m(!t,"RelayPaginationContainer: Only a single fragment with @connection is supported."),t=r({},o[0],{fragmentName:a}))}return m(!n||null!==t,"RelayPaginationContainer: A @connection directive must be present."),t||{}}(t),s=n.getConnectionFromProps||function(t){var n=t.path;return m(n,"RelayPaginationContainer: Unable to synthesize a getConnectionFromProps function."),function(r){for(var a=r[t.fragmentName],i=0;i<n.length;i++){if(!a||"object"!==(void 0===a?"undefined":e(a)))return null;a=a[n[i]]}return a}}(o),c=n.direction||o.direction;m(c,"RelayPaginationContainer: Unable to infer direction of the connection, possibly because both first and last are provided.");var l=n.getFragmentVariables||C(o);return{name:"relay-pagination-container",data:function(){var e=(0,a.environment.unstable_internal.createFragmentSpecResolver)(a,this.$options.name,t,this.$props,this._handleFragmentDataUpdate);return{context:Object.freeze({relay:{environment:a.environment,variables:a.variables}}),state:Object.freeze({data:e.resolve(),prevProps:this.$props,relayEnvironment:a.environment,relayVariables:a.variables,relayProp:this._buildRelayProp(a),isARequestInFlight:!1,localVariables:null,refetchSubscription:null,resolver:e}),switch:!0}},computed:{fragments:function(){var e=this;return Object.keys(t).forEach(function(t){return e[t]}),this.switch=!this.switch}},methods:{setState:function(e){this.state=Object.freeze(r({},this.state,e))},_buildRelayProp:function(e){return{hasMore:this._hasMore,isLoading:this._isLoading,loadMore:this._loadMore,refetchConnection:this._refetchConnection,environment:e.environment}},_handleFragmentDataUpdate:function(){this.setState({data:this.state.resolver.resolve()})},_getConnectionData:function(){var t=r({},this.$props,this.state.data),n=s(t);if(null==n)return null;var a=S.get(),i=a.EDGES,o=a.PAGE_INFO,l=a.HAS_NEXT_PAGE,u=a.HAS_PREV_PAGE,h=a.END_CURSOR,p=a.START_CURSOR;m("object"===(void 0===n?"undefined":e(n)),"RelayPaginationContainer: Expected `getConnectionFromProps()` in `%s`to return `null` or a plain object with %s and %s properties, got `%s`.",this.$options.name,i,o,n);var f=n[i],v=n[o];if(null==f||null==v)return null;m(Array.isArray(f),"RelayPaginationContainer: Expected `getConnectionFromProps()` in `%s`to return an object with %s: Array, got `%s`.",this.$options.name,i,f),m("object"===(void 0===v?"undefined":e(v)),"RelayPaginationContainer: Expected `getConnectionFromProps()` in `%s`to return an object with %s: Object, got `%s`.",this.$options.name,o,v);var b="forward"===c?v[l]:v[u],y="forward"===c?v[h]:v[p];return"boolean"!=typeof b||0!==f.length&&void 0===y?(g(!1,"RelayPaginationContainer: Cannot paginate without %s fields in `%s`. Be sure to fetch %s (got `%s`) and %s (got `%s`).",o,this.$options.name,"forward"===c?l:u,b,"forward"===c?h:p,y),null):{cursor:y,edgeCount:f.length,hasMore:b}},_hasMore:function(){var e=this._getConnectionData();return!!(e&&e.hasMore&&e.cursor)},_isLoading:function(){return!!this.state.refetchSubscription},_refetchConnection:function(e,t,n){var r={count:e,cursor:null,totalCount:e};return{dispose:this._fetchPage(r,P(t),{force:!0},n).unsubscribe}},_loadMore:function(e,t,n){var r=P(t),a=this._getConnectionData();if(!a)return R.create(function(e){return e.complete()}).subscribe(r),null;var i=a.edgeCount+e;if(n&&n.force)return this._refetchConnection(i,t);var o=S.get(),s=o.END_CURSOR,l=o.START_CURSOR,u=a.cursor;g(u,"RelayPaginationContainer: Cannot `loadMore` without valid `%s` (got `%s`)","forward"===c?s:l,u);var h={count:e,cursor:u,totalCount:i};return{dispose:this._fetchPage(h,r,n).unsubscribe}},_getQueryFetcher:function(){return this.state.queryFetcher||this.setState({queryFetcher:new i}),this.state.queryFetcher},_fetchPage:function(i,o,s,c){var u=this,h=a.environment,p=h.unstable_internal,f=p.createOperationSelector,v=p.getRequest,b=p.getVariablesFromObject,y=r({},this.$props,this.state.data),g=b(this.context.relay.variables,t,this.$props);g=r({},g,c);var _=n.getVariables(y,{count:i.count,cursor:i.cursor},g);m("object"===(void 0===_?"undefined":e(_))&&null!==_,"RelayPaginationContainer: Expected `getVariables()` to return an object, got `%s` in `%s`.",_,this.$options.name),_=r({},_,c),this.setState({localVariables:_});var S=s?{force:!!s.force}:void 0;S&&s&&s.rerunParamExperimental&&(S.rerunParamExperimental=s.rerunParamExperimental);var C=f(v(n.query),_);this.state.refetchSubscription&&this.state.refetchSubscription.unsubscribe();var P=function(){u.state.refetchSubscription===F&&(u.state.refetchSubscription.unsubscribe(),u.setState({refetchSubscription:null,isARequestInFlight:!1}))};this.setState({isARequestInFlight:!0});var F=this._getQueryFetcher().execute({environment:h,operation:C,cacheConfig:S,preservePreviousReferences:!0}).mergeMap(function(e){return R.create(function(e){!function(e,t){u.context.relay.environment=a.environment,u.context.relay.variables=r({},a.variables,g);var n=u.state.resolver.resolve();u.state.resolver.setVariables(l(g,i.totalCount));var o=u.state.resolver.resolve();d(n,o)||u.setState({data:o}),t()}(0,function(){e.next(),e.complete()})})}).do({error:P,complete:P,unsubscribe:P}).subscribe(o||{});return this.setState({refetchSubscription:this.state.isARequestInFlight?F:null}),F},_release:function(){this.state.resolver.dispose(),this.state.refetchSubscription&&(this.state.refetchSubscription.unsubscribe(),this.setState({refetchSubscription:null,isARequestInFlight:!1})),this.state.queryFetcher&&this.state.queryFetcher.dispose()}},watch:{fragments:function(){var e=a.environment.unstable_internal,n=e.createFragmentSpecResolver,r=e.getDataIDsFromObject,i=r(t,this.state.prevProps),o=r(t,this.$props);if(this.state.relayEnvironment===a.environment&&this.state.relayVariables===a.variables&&d(i,o))this.state.localVariables||this.state.resolver.setProps(this.$props);else{this._release(),this.context.relay.environment=a.environment,this.context.relay.variables=a.variables;var s=n(a,this.$options.name,t,this.$props,this._handleFragmentDataUpdate);this.setState({prevProps:this.$props,relayEnvironment:a.environment,relayVariables:a.variables,relayProp:this._buildRelayProp(a),localVariables:null,resolver:s})}var c=this.state.resolver.resolve();c!==this.state.data&&this.setState({data:c})}},beforeDestroy:function(){this._release()}}},x=require("fbjs/lib/areEqual"),q=require("fbjs/lib/invariant"),E=function(e){var t=this.relay;return{name:"relay-fragment-container",data:function(){var n=(0,t.environment.unstable_internal.createFragmentSpecResolver)(t,this.$options.name,e,this.$props,this._handleFragmentDataUpdate);return{state:Object.freeze({data:n.resolve(),prevProps:this.$props,relayEnvironment:t.environment,relayVariables:t.variables,relayProp:{isLoading:n.isLoading(),environment:t.environment},resolver:n}),switch:!0}},computed:{fragments:function(){var t=this;return Object.keys(e).forEach(function(e){return t[e]}),this.switch=!this.switch}},methods:{setState:function(e){this.state=Object.freeze(r({},this.state,e))},_handleFragmentDataUpdate:function(){this.setState({data:this.state.resolver.resolve(),relayProp:{isLoading:this.state.resolver.isLoading(),environment:this.state.relayProp.environment}})}},watch:{fragments:function(){var n=t.environment.unstable_internal,r=n.createFragmentSpecResolver,a=n.getDataIDsFromObject,i=a(e,this.state.prevProps),o=a(e,this.$props),s=this.state.resolver;if(this.state.relayEnvironment===t.environment&&this.state.relayVariables===t.variables&&x(i,o)){s.setProps(this.$props);var c=s.resolve();c!==this.state.data&&this.setState({data:c,prevProps:this.$props,relayEnvironment:t.environment,relayVariables:t.variables,relayProp:{isLoading:s.isLoading(),environment:t.environment}})}else s.dispose(),s=r(t,this.$options.name,e,this.$props,this._handleFragmentDataUpdate),this.setState({data:s.resolve(),prevProps:this.$props,relayEnvironment:t.environment,relayVariables:t.variables,relayProp:{isLoading:s.isLoading(),environment:t.environment},resolver:s})}},beforeDestroy:function(){this.state.resolver.dispose()}}},j=require("relay-runtime");return{QueryRenderer:l,MutationTypes:j.MutationTypes,RangeOperations:j.RangeOperations,commitLocalUpdate:j.commitLocalUpdate,commitMutation:j.commitMutation,createRefetchContainer:function(){b(2===arguments.length||3===arguments.length,"createRefetchContainer: Expected `arguments.length` to be 2 or 3, got `%s`.",arguments),2===arguments.length&&[].unshift.call(arguments,null);var e=Array.prototype.slice.call(arguments),t=e[0],n=e[1],a=e[2];return f(t,n,function(e){return function(e,t){var n=this.relay;return{name:"relay-refetch-container",data:function(){var t=(0,n.environment.unstable_internal.createFragmentSpecResolver)(n,this.$options.name,e,this.$props,this._handleFragmentDataUpdate);return{context:Object.freeze({relay:{environment:n.environment,variables:n.variables}}),state:Object.freeze({data:t.resolve(),prevProps:this.$props,relayEnvironment:n.environment,relayVariables:n.variables,relayProp:this._buildRelayProp(n),localVariables:null,refetchSubscription:null,resolver:t}),switch:!0}},computed:{fragments:function(){var t=this;return Object.keys(e).forEach(function(e){return t[e]}),this.switch=!this.switch}},methods:{setState:function(e){this.state=Object.freeze(r({},this.state,e))},_buildRelayProp:function(e){return{environment:e.environment,refetch:this._refetch}},_handleFragmentDataUpdate:function(){this.setState({data:this.state.resolver.resolve()})},_getFragmentVariables:function(){return(0,n.environment.unstable_internal.getVariablesFromObject)(n.variables,e,this.$props)},_getQueryFetcher:function(){return this.state.queryFetcher||this.setState({queryFetcher:new i}),this.state.queryFetcher},_refetch:function(e,a,i,o){var s=this,c=n.environment,l=n.variables,u=c.unstable_internal,h=u.createOperationSelector,p=u.getRequest,f="function"==typeof e?e(this._getFragmentVariables()):e;f=r({},l,f);var v=a?r({},l,a):f;this.setState({localVariables:f});var b=o?{force:!!o.force}:void 0,d="function"==typeof i?{next:i,error:i}:i||{},m=h(p(t),f);this.state.refetchSubscription&&this.state.refetchSubscription.unsubscribe();var g=void 0;return this._getQueryFetcher().execute({environment:c,operation:m,cacheConfig:b,preservePreviousReferences:!0}).mergeMap(function(e){return s.context.relay.environment=n.environment,s.context.relay.variables=v,s.state.resolver.setVariables(v),y.create(function(e){s.setState({data:s.state.resolver.resolve()}),e.next(),e.complete()})}).finally(function(){s.state.refetchSubscription===g&&(s.state.refetchSubscription.unsubscribe(),s.setState({refetchSubscription:null}))}).subscribe(r({},d,{start:function(e){g=e,s.setState({refetchSubscription:e}),d.start&&d.start(e)}})),{dispose:function(){g&&g.unsubscribe()}}},_release:function(){this.state.resolver.dispose(),this.state.refetchSubscription&&(this.state.refetchSubscription.unsubscribe(),this.setState({refetchSubscription:null})),this.state.queryFetcher&&this.state.queryFetcher.dispose()}},watch:{fragments:function(){var t=n.environment.unstable_internal,r=t.createFragmentSpecResolver,a=t.getDataIDsFromObject,i=a(e,this.state.prevProps),o=a(e,this.$props);if(this.state.relayEnvironment===n.environment&&this.state.relayVariables===n.variables&&v(i,o))this.state.localVariables||this.state.resolver.setProps(this.$props);else{this._release(),this.context.relay.environment=n.environment,this.context.relay.variables=n.variables;var s=r(n,this.$options.name,e,this.$props,this._handleFragmentDataUpdate);this.setState({prevProps:this.$props,relayEnvironment:n.environment,relayVariables:n.variables,relayProp:this._buildRelayProp(n),localVariables:null,resolver:s})}var c=this.state.resolver.resolve();c!==this.state.data&&this.setState({data:c})}},beforeDestroy:function(){this._release()}}}.call(this,e,a)})},createPaginationContainer:function(){m(2===arguments.length||3===arguments.length,"createPaginationContainer: Expected `arguments.length` to be 2 or 3, got `%s`.",arguments),2===arguments.length&&[].unshift.call(arguments,null);var e=Array.prototype.slice.call(arguments),t=e[0],n=e[1],r=e[2];return f(t,n,function(e){return F.call(this,e,r)})},createFragmentContainer:function(){q(1===arguments.length||2===arguments.length,"createFragmentContainer: Expected `arguments.length` to be 1 or 2, got `%s`.",arguments),1===arguments.length&&[].unshift.call(arguments,null);var e=Array.prototype.slice.call(arguments),t=e[0],n=e[1];return f(t,n,E)},fetchQuery:j.fetchQuery,graphql:j.graphql,requestSubscription:j.requestSubscription}});
